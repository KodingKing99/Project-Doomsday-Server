# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Run Commands

```bash
dotnet build                    # Build entire solution
dotnet test                     # Run all tests
dotnet run --project src/ProjectDoomsdayServer.WebApi  # Run the API server

# Run a single test class
dotnet test --filter "FullyQualifiedName~FileCrudIntegrationTests"

# Run a single test method
dotnet test --filter "FullyQualifiedName~FileCrudIntegrationTests.CreateFile_ReturnsCreated"

# Format code (CSharpier)
dotnet csharpier format .
```

## Project Architecture

.NET 9 project following hexagonal/clean architecture with ports and adapters.

```
Dependency flow (outside-in): WebApi → Infrastructure → Application → Domain
```

- **Domain** — Pure models, no dependencies. `File` domain model, configuration POCOs (`MongoDbConfig`, `S3Config`).
- **Application** — Business logic and port interfaces. `IFilesService`/`FilesService` orchestrates operations. Defines `IFileStorage` and `IFileRepository` as ports.
- **Infrastructure** — Adapter implementations. `MongoDbFileRepository`, `S3FileStorage`, `LocalFileStorage`, `InMemoryFileRepository`. DI registration via `AddInfrastructureServices()`.
- **WebApi** — ASP.NET Core entry point. `Program.cs` is the DI composition root. Controllers call into Application layer services.
- **ApiTests** — Integration tests using `WebApplicationFactory<Program>`. `CustomWebApplicationFactory` replaces real storage/repository with NSubstitute mocks.
- **E2ETests** — Full-stack E2E tests using Testcontainers. Spins up real MongoDB and MinIO (S3-compatible) Docker containers. No mocks — exercises the full presigned URL upload workflow.

## Key Patterns

- **Storage key format**: `{UserId}/{FileId}` — generated after the file record is created.
- **Presigned URL workflow**: `POST /files` creates metadata and returns a presigned S3 PUT URL. The client uploads directly to S3.
- **Pagination**: `GET /files?skip=0&take=50`. Take is clamped to max 200. Results sorted by `UpdatedAtUtc` descending.
- **Authentication**: Optional Cognito JWT Bearer, toggled via `Authentication:Enabled` in config.
- **All I/O is async** with `CancellationToken` threaded throughout.
- **File.Id** is nullable on creation (auto-generated by MongoDB's `StringObjectIdGenerator`).
- **REST endpoints**: Separate `POST /files` (create) and `PUT /files/{id}` (update) — not upsert.

## Test Patterns

Two test suites:

**ApiTests** (`src/ProjectDoomsdayServer.ApiTests/`) — Fast, no Docker required.
- Uses `IClassFixture<CustomWebApplicationFactory>` with NSubstitute mocks for `IFileStorage` and `IFileRepository`.
- Factory tracks operations via `SavedFiles`, `DeletedFileIds`, and `FileRecords` dictionaries. Call `factory.Reset()` between tests to clear state.
- Run with: `dotnet test --filter "FullyQualifiedName~ApiTests"`

**E2ETests** (`src/ProjectDoomsdayServer.E2ETests/`) — Full-stack, requires Docker.
- Uses `ICollectionFixture<E2EInfrastructureFixture>` (shared containers across all test classes) + per-class `E2EWebApplicationFactory`.
- Testcontainers spins up MongoDB (`mongo:7.0`) and MinIO containers automatically.
- Test isolation via `UniqueUserId()` — each test uses a unique `{UserId}` prefix; no teardown needed.
- `_appClient` routes to the in-process server; `_rawHttpClient` hits MinIO directly for presigned URL PUT uploads.
- Run with: `dotnet test --filter "FullyQualifiedName~E2ETests"`

Assertions use FluentAssertions (`response.StatusCode.Should().Be(HttpStatusCode.OK)`).

## Configuration

Development config is in `appsettings.Development.json`:
- AWS Profile: `DoomsdayAdmin-027903755990`, Region: `us-west-2`
- S3 Bucket: `project-doomsday-files-bucket`
- MongoDB: `mongodb://localhost:27017`, Database: `ProjectDoomsday`

`Program.cs` requires a partial class declaration in `ProgramPartial.cs` to expose `Program` to `WebApplicationFactory<Program>` in tests.
